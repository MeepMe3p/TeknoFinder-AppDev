<html>
    <head>
        <!-- Leaflet CSS -->
        <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
        crossorigin=""/>
        <!-- Leaflet javascript-->
        <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
        crossorigin=""></script>

        <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet">
	    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

        <link rel="stylesheet" href="../css/map.css">
    </head>

    <body>
        <div id="map_sidebar">
            <img style="height: 80px; width: 80px;" src="../assets/teknofinder-logo.png">
            <div id="top_half">
                <div id="home" class="sidebar_button">
                    <i style="font-size: 40px;" class="fas fa-home"></i>
                    <p>Home</p>
                </div>
                <div id="navigator" class="sidebar_button">
                    <i style="font-size: 40px;" class="fas fa-search"></i>
                    <p>Search</p>
                </div>
                <div onclick="GetWaypoint()" class="sidebar_button">
                    <i style="font-size: 40px;" class="fas fa-bookmark"></i>
                    <p>Saved</p>
                </div>
                <div class="sidebar_button">
                    <i style="font-size: 40px;" class="far fa-clock"></i>
                    <p>Schedule</p>
                </div>
            </div>

            <div id="bottom_half">
                <div class="sidebar_button">
                    <i style="font-size: 40px;" class="fa fa-user"></i>
                    <p>Profile</p>
                </div>
            </div>
        </div>
        
        <div id="map"></div>
        <div id="debug_menu">
            <div>
                <label for="name">Name:</label>
                <input type="text" id="name" name="name">
            
                <label for="coordX">X coordinate: </label>
                <input type="text" id="coordX" name="coordX">
            
                <label for="coordY">Y coordinate: </label>
                <input type="text" id="coordY" name="coordY">
            </div>
            <button onclick="DeleteWaypoint()">test</button>
        </div>
        
        
    </body>

    <script>
        var imageUrl = '../maps/NGE_test.png';
        var imageBounds = [[0,0], [234,153]]; 
        const map = L.map('map').setView([0, 0], 13);
        const UserLayer = L.layerGroup().addTo(map);
        const PathLayer = L.layerGroup().addTo(map);
        const Overlays = {
            "Path Markers": PathLayer,
            "User Markers": UserLayer
        }
        L.imageOverlay(imageUrl, imageBounds).addTo(map);
        L.control.layers(null, Overlays).addTo(map);



        map.on('click', function(e) {
            var latlng = e.latlng; // Get the latitude and longitude of the clicked point
            console.log("You clicked at: " + latlng.lat + ", " + latlng.lng);

            // Optionally add a marker at the clicked position
            var newMarker = CreateUserMarker(latlng.lat, latlng.lng).addTo(map);
        });

        const PathNodes = [];
        
        function CreateUserMarker(lat, lng){
            var customIcon = L.icon({
                iconUrl: '../assets/marker.png',
                iconSize: [32, 43],
                iconAnchor: [16, 43],
                popupAnchor: [0, -43]
            });

            var marker = L.marker([lat, lng], { icon: customIcon }).addTo(map);
            //not very cursed popup code now for the sake of UI/UX
            var pElement = document.createElement('p');
            pElement.textContent = 'I am a user generated Marker!';
            var popupContent = document.createElement('div');
            var clearButton = document.createElement('button');
            clearButton.innerHTML = "Clear Me";
            clearButton.onclick = function () {
                RemoveMarker(marker); //use delete for saved waypoints
            };

            var saveButton = document.createElement('button');
            saveButton.innerHTML = "Save Me";
            saveButton.onclick = function () {
                setMarkerName(marker); //use edit for saved waypoints
            };

            popupContent.appendChild(pElement);
            popupContent.appendChild(clearButton);
            popupContent.appendChild(saveButton);

            marker.bindPopup(popupContent);
            return marker;
        }

        function AddWaypoint(){
            const name = document.getElementById('name').value;
            const coordX = document.getElementById('coordX').value;
            const coordY = document.getElementById('coordY').value;
            
            console.log('Sending waypoint:', { name, coordX, coordY });
                
                fetch(`http://localhost:5099/api/Waypoints`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        waypointName: name,
                        waypointType: "UserPin",
                        pointX: coordX,
                        pointY: coordY,
                        Building: "NGE", 
                        Floor: 0,
                    })
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! Status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(json => console.log(json))
                .catch(error => console.error('Error:', error))
            
        }

        function GetWaypoint(){
                fetch(`http://localhost:5099/api/Waypoints`,{
                    method:'GET',
                    headers:{
                        'Content-Type': 'application/json',
                    }
                })
                .then(response => response.json())
                .then(markers => {
                    console.log(markers)
                    let count = 0
                    markers.forEach(marker => {
                    const { pointX, pointY, waypointName, waypointType } = marker; // Destructure the data

                    var customIcon = L.icon({
                        iconUrl: '../assets/pathnode_icon.png',
                        iconSize: [16, 16]
                    });
                    

                    if(waypointType == 'PathNode'){
                        PathNodes[count] = L.marker([pointX, pointY], { icon: customIcon }).addTo(map)
                        .bindPopup(`<b>${waypointName}</b>`);
                        PathLayer.addLayer(PathNodes[count]);
                    }else{
                        var usermarker = CreateUserMarker(pointX, pointY);
                        UserLayer.addLayer(usermarker);
                    }
                    
                    count++
                    });
                })

                for(node in PathNodes){
                    console.log('Node #${index}: ${node}')
                }
        }
        
        function DeleteWaypoint(x, y){
            fetch(`http://localhost:5099/api/Waypoints`,{
                    method:'GET',
                    headers:{
                        'Content-Type': 'application/json',
                    }
                })
                .then(response => response.json())
                .then(markers => {
                    markers.forEach(marker => {
                        if(marker.PointX == x && marker.PointY == y){
                            console.log(user.id);  // Display user id in console
                        }
                    });
                })
        }

        function setMarkerName(marker) {
            var userInput = prompt('Please enter a number:');
            if (userInput !== null) {
                alert('You entered: ' + userInput);
            }

            document.getElementById('name').value = userInput;
            document.getElementById('coordX').value = marker.getLatLng().lng;
            document.getElementById('coordY').value = marker.getLatLng().lat;
            AddWaypoint();
        }

        function RemoveMarker(marker){
            console.log(marker.getLatLng());
            map.removeLayer(marker);
        }
    </script>
</html>